#!/bin/bash
# Compare demo output with known good demo output
SKIP_TEST_EXITCODE=77

test_lpsolve() {
  $builddir/lp_solve $opts $inputfile > $outfile;
  if test "@DIFF@" != no; then
    if @DIFF@ @DIFF_OPTS@ ${outfile} ${rightfile} ; then
      rm -f $outfile
      return 0
    else
      return 3
    fi
  else
    return $SKIP_TEST_EXITCODE
  fi
}

check_result() {
  RC=$1
  shift
  msg=$1
  shift
  cmdline=$*
  if test $RC -ne 0 ; then 
    if test $RC -ne $SKIP_TEST_EXITCODE ; then
      echo "$0: $msg failed in comparing output."
      if test -n "$cmdline" ; then 
        echo "$0: failed command:"
        echo "	$cmdline"
      fi
      exit $RC
    else 
      echo "$0: $msg skipped."
    fi
  else 
    echo "$0: $msg ok."
  fi
}

test_and_check() {
  inputfile=$top_builddir/test/${1}.lp
  rightfile=$srcdir/${1}.right
  outfile=$builddir/${1}.out
  opts=$2
  msg=$3

  test_lpsolve
  RC=$?
  check_result $RC "${3}: lp_solve $opts $inputfile"
}

srcdir=@srcdir@
buildddir=@builddir@
top_buildddir=@top_builddir@
if test "X$top_builddir" = "X" ; then
  top_builddir=..
fi
if test "X$builddir" = "X" ; then
  builddir=.
fi
if test "X$srcdir" = "X" ; then
  srcdir=.
fi

test_and_check e1  "-lp -s -S3" "Presolve Column Dominate"

test_and_check coldombug "-lp -s -S3 -presolvecold" "Presolve Column Dominate again"

# Another test of presolvecold ...
test_and_check colbug "-lp -s -S3 -presolvecol -presolvecold -presolvec" "presolvec and presolvecol"

# A test of anticycling code
test_and_check ex7 "-lp -s -S1" "anticycling code"
